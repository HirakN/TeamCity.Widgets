<!--
  ~ Copyright 2000-2015 JetBrains s.r.o.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<link rel="import" href="tree-view.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<dom-module id="projects-presenter">
    <template>
        <iron-signals on-iron-signal-terms="filterResult"/>
        <!--<iron-list items="[[filtered]]" as="item" style="height: 100%;">
            <template>
                <div>
                    <tree-view data="{{item}}"></tree-view>
                </div>
            </template>
        </iron-list>-->
        <template is="dom-repeat" items="{{filtered}}">
            <div>
                <tree-view data="{{item}}"></tree-view>
            </div>
        </template>
    </template>
    <script>
        // element registration
        Polymer({
            is: "projects-presenter",
            properties: {
                dataTree:{
                    type: Object,
                    observer: "_dataTreeChanged",
                    notify: true
                },
                filtered:{
                    type: Object,
                    notify: true,
                    computed: "filteredData(dataTree, terms)"
                },
                terms:{
                    type: String,
                    value: "",
                    notify: true
                }
            },
            _dataTreeChanged: function(){

            },
            filteredData: function(dataTree, terms){
                if (terms == ""){
                    return dataTree[0].children;
                }

                return this.filteredTreeData(JSON.parse(JSON.stringify(dataTree))[0].children, new RegExp(terms.replace(/[.*+?^${}()|[\]\/\\]/g, '\\$&'), 'i'));
            },
            filteredTreeData: function(children, re){
                if (children == undefined || children.length == 0){
                    return [];
                }
                var d = [];
                var self = this;
                children.forEach(function(node){
                    var c = self.filteredTreeData(node.children, re);
                    var hasRequiredText = re.test(node.text);
                    if (c.length>0 || hasRequiredText){
                        node.isExpanded = true;
                        node.children = c;
                        d.push(node);
                    }
                });
                return d;
            },
            filterResult: function(e, detail, sender){
                this.terms = detail;
            },
            filterChildren: function(arr){
               var d = [];
               arr.forEach(function(node){
                    if (node.text.indexOf(terms)>-1){
                        d.push(node);
                    }
                });
               return d;
            }
        });
    </script>
</dom-module>