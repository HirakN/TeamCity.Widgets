<!--
  ~ Copyright 2000-2015 JetBrains s.r.o.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<script type="text/javascript">
    ConverterBehavior = {
            flatToNested: function (data){
                var dataMap = data.reduce(function(map, node) {
                    map[node.id] = node;
                    return map;
                }, {});

                console.log(dataMap);

                var dataTree = [];
                for (var i=0; i<data.length; i++){
                    var node = data[i];
                    // add to parent
                    node.text = node.name;
                    node.isExpanded = false;
                    var bts = node.buildTypes!=undefined ? node.buildTypes.buildType : undefined;
                    node.href = node.webUrl;
                    if (node.id == '_Root'){
                        var serverName = node.webUrl.replace('/project.html?projectId=_Root','');
                        node.text = serverName;
                        node.name = serverName;
                        node.isExpanded = true;
                    }
                    var parent = dataMap[node.parentProjectId];
                    if (parent) {
                        // create child array if it doesn't exist
                        var pp = (parent.children || (parent.children = []));
                        pp.push(node);
                        if (bts != undefined && bts.length>0){
                            var ppp = (node.children || (node.children = []));
                            for (var z=0; z<bts.length; z++) {
                                var bt = {
                                    text: bts[z].name,
                                    href: bts[z].webUrl,
                                    isBuildType: true,
                                    parentProjectId: node.id,
                                    isExpanded: false
                                };
                                ppp.push(bt);
                            }
                        }
                    } else {
                        // parent is null or missing
                        dataTree.push(node);
                    }
                }
                return dataTree;
            }
    };
</script>